# upClock 技术方案

## 背景与产品目标
- 打造一款轻量级的后台助手，持续监测久坐时长并在超出可配置阈值时提醒用户。
- 全流程在本机完成处理，兼顾隐私与低资源占用，确保可长时间运行。
- 采用迭代式交付：先落地键鼠活动与活跃窗口信号，再补强可视化与提醒，最后扩展摄像头/麦克风模块。

## 非目标（当前阶段）
- 不做跨设备同步或云端服务。
- 不做复杂姿态识别或人脸识别，视觉模块仅需检测“有人”及粗略坐姿。
- 不打造长期数据看板，先聚焦准实时反馈与提醒。

## 支持平台与技术栈
- **桌面系统**：优先支持 macOS，同时预留结构以便后续扩展 Windows/Linux。
- **核心服务**：Python 3.11+，基于 asyncio 的事件循环。
- **操作系统钩子**：
  - macOS：通过 `Quartz`、`pyobjc` 捕捉键鼠事件，`NSWorkspace` 获取活跃窗口。
  - Windows（后续）：`pywin32`、`pyWinhook`。
  - Linux（后续）：`python-xlib`、`xdotool` 等。
- **数据层**：内存环形缓冲区记录最近 N 分钟数据，可选 SQLite 保存历史。
- **配置管理**：使用 `pydantic` 模型，配合 YAML 配置文件或命令行参数。
- **API 接口**：FastAPI 提供 REST 与 WebSocket；为 UI 和第三方集成服务。
- **可视化**：初期可使用简易 HTML + Chart.js；后续采用 Svelte + Vite 的单页应用。
- **提醒机制**：macOS 通过 `osascript` 或 `pync`；后续抽象统一接口。

## 整体架构
```
+-------------------+
|  Input Adapters   |  键鼠钩子、活跃窗口、（后续）视觉、音频
+---------+---------+
          |
          v
+-------------------+
|   Signal Buffer   |  时间戳事件、滚动统计、数据归一化
+---------+---------+
          |
          v
+-------------------+
|  Activity Engine  |  特征提取、加权评分、阈值判断、状态机
+---------+---------+
          |
   +------+------+
   |             |
   v             v
UI & Notifications   本地 API (REST/WebSocket)
```

## 迭代路线图

### 迭代 0 —— 项目脚手架与遥测基线（0.5 周）
- 初始化目录结构：`core/`、`adapters/`、`ui/`、`tests/`、`scripts/`。
- 编写配置加载、日志、依赖注入骨架。
- 定义 `InputAdapter`、`SignalBuffer`、`ActivityEngine`、`Notifier` 接口桩。
- 搭建 FastAPI 服务与健康检查端点，配置热重载开发环境。
- 使用 pytest 编写配置加载与适配器桩的基础单测。

### 迭代 1 —— 核心指标 MVP（1 周）
- 实现 macOS 键鼠活动适配器，采集事件时间戳与活动计数。
- 实现活跃窗口追踪（应用 bundle id、窗口标题），支持白/黑名单分类。
- 构建滚动聚合（如 1 分钟粒度、最近 30 分钟），通过 REST & WebSocket 暴露数据。
- 设计闲置时长 + 窗口类别权重的初版评分策略。
- 提供 CLI 与 API JSON 摘要，记录阈值触发日志。
- 构建最小化 HTML 仪表盘（FastAPI 模板），展示活动时间线与当前状态。
- 编写合成事件回放的单元/集成测试，整理手测清单。

### 迭代 2 —— 提醒与可视化升级（1 周）
- 抽象通知服务并接入 macOS 通知中心。
- 支持用户配置阈值、静默时段、活动衰减（YAML 配置 + 热加载）。
- 使用 Svelte SPA 替换 HTML，WebSocket 实时显示活动评分及信号指示。
- 将最近指标写入 SQLite 保留会话连续性，并设置数据保留策略。
- 添加 API + UI 冒烟测试（Playwright 无头）与端到端脚本模拟久坐/活动场景。

### 迭代 3 —— 可扩展能力打底（1 周）
- 设计扩展传感器的插件接口，注册摄像头/音频占位模块。
- 实现能力检测与特性开关，按硬件/权限动态启停模块。
- 撰写开发者指南，说明如何新增适配器并发布 API Schema。
- 进行性能剖析（内存/CPU），优化采样频率与批量处理。

### 迭代 4 —— 可选传感器原型（未来）
- 集成轻量化人在位模型（如 MediaPipe BlazePose Lite 或 PyTorch/ONNX Runtime），支持帧跳跃推理。
- 新增麦克风音量监测，提供显式授权与匿名化统计。
- 扩展 Activity Engine 的权重逻辑，将新信号纳入评分并更新 UI 显示。

## 数据与评分策略
- **事件结构**：`InputEvent(timestamp, source, payload)`，归一为每分钟活动计数。
- **窗口分类**：配置文件维护 `work`、`neutral`、`leisure` 标签，默认规则 + 用户自定义。
- **活动评分**：多信号加权求和，配合指数衰减的空闲计时器；状态划分为 `Active`、`Short Idle`、`Prolonged Idle`。
- **阈值设置**：默认 15 分钟进入 `Short Idle`，45 分钟进入 `Prolonged Idle`，可按用户偏好调整。

## 可观测性与测试
- 结构化日志（JSON），每次会话使用关联 ID。
- 健康检查指标：运行时长、事件速率、队列积压等。
- 针对评分引擎与适配器的单元测试（Mock OS 钩子）。
- 使用录制事件轨迹进行集成测试。
- UI 快照测试覆盖 `Active`/`Idle`/`Alert` 等关键状态。

## 隐私与权限
- 所有数据在本地处理，不走网络。
- 提供界面/配置开关以禁用摄像头、麦克风模块；默认关闭直至用户授权。
- 仅存储聚合指标，不保存原始按键或窗口标题（除分类信息外）。

## 风险与缓解
- **系统钩子不稳定**：统一抽象适配器，增强容错与回退机制。
- **资源占用过高**：定期剖析，允许调节采样频率，在空闲时暂停采集。
- **误报/漏报**：持续调优权重并增加用户反馈通道。
- **权限缺失**：运行时检测，提示用户开启辅助功能/屏幕录制权限，提供操作指引。

## 近期行动清单
1. 生成项目脚手架，落地模块化目录与依赖管理（poetry 或 uv）。
2. 完成 macOS 键鼠适配器 MVP，验证事件采集准确性。
3. 搭建 FastAPI 服务并输出基础指标，便于手动验证。
4. 草拟可视化线框图，为迭代 2 的 UI 升级做准备。
